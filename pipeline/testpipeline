version: 2.1

executors:
  docker-executor:
    docker:
      - image: circleci/python:3.8
    working_directory: ~/project

jobs:
  checkout:
    executor: docker-executor
    steps:
      - checkout

  load-scripts:
    docker:
      - image: circleci/python:3.8
    steps:
      - checkout
      - run:
          name: Load Scripts
          command: |
            # Example script loading
            echo "Loading scripts..."
            # Here you would script out the logic to load your scripts
            # For instance, you might copy scripts to a specific location or similar
            # Adapt this to your actual use case

  git-checkout:
    docker:
      - image: circleci/python:3.8
    steps:
      - checkout
      - run:
          name: Git Checkout Source Code Repo
          command: |
            git clone ${GIT_SOURCE_CODE_URL}
            cd repo
            git checkout ${SOURCE_CODE_BRANCH_NAME}

  build:
    docker:
      - image: circleci/node:14
    steps:
      - checkout
      - run:
          name: Build with NPM
          command: |
            cd repo
            npm install
            npm run build

  unit-test:
    docker:
      - image: circleci/node:14
    steps:
      - checkout
      - run:
          name: Unit Test
          command: |
            cd repo
            npm test

  sonar-analysis:
    docker:
      - image: circleci/python:3.8
    steps:
      - checkout
      - run:
          name: SonarQube Analysis
          command: |
            # Example SonarQube analysis command
            sonar-scanner -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
                           -Dsonar.organization=${SONAR_ORGANIZATION} \
                           -Dsonar.sources=${SONAR_SOURCES_DIR} \
                           -Dsonar.token=${SONAR_TOKEN}

  docker-build:
    docker:
      - image: circleci/docker:20.10
    steps:
      - checkout
      - run:
          name: Docker Build
          command: |
            docker build -t ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} .

  docker-scan:
    docker:
      - image: circleci/docker:20.10
    steps:
      - checkout
      - run:
          name: Docker Scan
          command: |
            # Example Docker scan command
            docker scan ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}

  docker-publish:
    docker:
      - image: circleci/docker:20.10
    steps:
      - checkout
      - run:
          name: Docker Publish
          command: |
            echo "${DOCKER_CREDENTIAL}" | docker login -u ${DOCKER_USERNAME} --password-stdin ${DOCKER_REPO}
            docker push ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}

workflows:
  version: 2
  build-and-test:
    jobs:
      - checkout
      - load-scripts
      - git-checkout
      - build
      - unit-test
      - sonar-analysis
      - docker-build
      - docker-scan
      - docker-publish
