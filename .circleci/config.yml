version: 2.1

executors:
  default:
    docker:
      - image: circleci/python:3.8

jobs:
  setup:
    executor: default
    steps:
      - checkout

      # Install required packages including Java 17
      - run:
          name: Install Java 17 and other packages
          command: |
            sudo apt-get update
            sudo apt-get install -y unzip wget openjdk-17-jdk

      # Set JAVA_HOME environment variable for Java 17
      - run:
          name: Set JAVA_HOME
          command: |
            export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
            echo 'export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64' >> $BASH_ENV
            echo 'export PATH=$JAVA_HOME/bin:$PATH' >> $BASH_ENV
            source $BASH_ENV

      # Install Node.js and npm
      - run:
          name: Install Node.js and npm
          command: |
            curl -fsSL https://deb.nodesource.com/setup_16.x | sudo -E bash -
            sudo apt-get install -y nodejs
            node --version
            npm --version

      # Install SonarQube Scanner
      - run:
          name: Install SonarQube Scanner
          command: |
            wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.6.2.2472-linux.zip
            unzip sonar-scanner-cli-4.6.2.2472-linux.zip
            sudo mv sonar-scanner-4.6.2.2472-linux /opt/sonar-scanner
            sudo ln -sf /opt/sonar-scanner/bin/sonar-scanner /usr/local/bin/sonar-scanner

      # Set SonarQube environment variables
      - run:
          name: Set SonarQube Environment Variables
          command: |
            echo 'export SONAR_SCANNER_HOME=/opt/sonar-scanner' >> $BASH_ENV
            echo 'export PATH=$SONAR_SCANNER_HOME/bin:$PATH' >> $BASH_ENV
            source $BASH_ENV

      # Verify SonarQube Scanner installation
      - run:
          name: Verify SonarQube Scanner Installation
          command: |
            sonar-scanner --version || /opt/sonar-scanner/bin/sonar-scanner --version

      # Run SonarQube Analysis
      - run:
          name: Run SonarQube Analysis
          command: |
            sonar-scanner \
              -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
              -Dsonar.organization=${SONAR_ORG} \
              -Dsonar.sources=. \
              -Dsonar.host.url=https://sonarcloud.io \
              -Dsonar.login=${SONAR_TOKEN} \
              -Dsonar.java.binaries=target/classes \
              -X

      # Build Docker Image and other steps...

workflows:
  version: 2
  build:
    jobs:
      - setup
